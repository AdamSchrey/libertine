#!/usr/bin/python3
# -*- coding: utf-8 -*-

# Copyright (C) 2014 Canonical Ltd.
# Author: Christopher Townsend <christopher.townsend@canonical.com>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 3 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import argparse
import json
import libertine.utils
import lsb_release
import getpass
import os
import sys

from distro_info import UbuntuDistroInfo, DistroDataOutdated
from libertine import LibertineContainer


def read_container_config_file():
    container_list = {}
    container_config_file = libertine.utils.get_libertine_database_file_path()

    if os.path.exists(container_config_file):
        with open(container_config_file, 'r') as fd:
            container_list = json.load(fd)

        fd.close()

    return container_list


def write_container_config_file(container_list):
    container_config_file = libertine.utils.get_libertine_database_file_path()

    with open(container_config_file, 'w') as fd:
        json.dump(container_list, fd, sort_keys=True, indent=4)
        fd.write('\n')

    fd.close()


def get_default_container_id():
    default_container_id = None

    container_list = read_container_config_file()

    if "defaultContainer" in container_list:
        default_container_id = container_list['defaultContainer']

    return default_container_id


def get_host_distro_release():
    distinfo = lsb_release.get_distro_information()

    return distinfo.get('CODENAME', 'n/a')


def is_distro_valid(distro):
    supported_distros = UbuntuDistroInfo().supported()

    try:
        supported_distros.index(distro)
    except ValueError:
        return False

    return True


def get_distro_codename(distro):
    ubuntu_distro_info = UbuntuDistroInfo()

    for row in ubuntu_distro_info._rows:
        if row['series'] == distro:
            return row['codename']

    return None


def container_exists(container_id):
    container_list = read_container_config_file()

    if container_list:
        for container in container_list['containerList']:
            if container['id'] == container_id:
                return True

    return False


def update_container_install_status(container_id, new_status):
    container_list = read_container_config_file()

    for container in container_list['containerList']:
        if container['id'] == container_id:
            container['installStatus'] = new_status

            write_container_config_file(container_list)
            break


def add_new_container(id, name, type, distro):
    if not os.path.exists(libertine.utils.get_libertine_database_dir_path()):
        os.makedirs(libertine.utils.get_libertine_database_dir_path())

    container_list = read_container_config_file()

    container_obj = {'id': id, 'installStatus': 'new', 'type': type,
                     'distro': distro, 'name': name, 'installedApps': []}

    if "defaultContainer" not in container_list:
        container_list['defaultContainer'] = id

    if "containerList" not in container_list:
        container_list['containerList'] = [container_obj]
    else:
        container_list['containerList'].append(container_obj)

    write_container_config_file(container_list)


def delete_container(container_id):
    container_list = read_container_config_file()

    if not container_list:
        print("Unable to delete container.  No containers defined.")
        sys.exit(1)

    for container in container_list['containerList']:
        if container['id'] == container_id:
            container_list['containerList'].remove(container)

            # Set a new defaultContainer if the current default is being deleted.
            if container_list['defaultContainer'] == container_id and container_list['containerList']:
                container_list['defaultContainer'] = container_list['containerList'][0]['id']
            # Remove the defaultContainer if there are no more containers left.
            elif not container_list['containerList']:
                del container_list['defaultContainer']

            write_container_config_file(container_list)
            break


def package_exists(container_id, package_name):
    container_list = read_container_config_file()

    if not container_list:
        return False

    for container in container_list['containerList']:
        if container['id'] == container_id:
            for package in container['installedApps']:
                if package['packageName'] == package_name:
                    return True

    return False


def update_package_install_status(container_id, package_name, new_status):
    container_list = read_container_config_file()

    for container in container_list['containerList']:
        if container['id'] == container_id:
            for package in container['installedApps']:
                if package['packageName'] == package_name:
                    package['appStatus'] = new_status
                    write_container_config_file(container_list)
                    return


def add_new_package(container_id, package_name):
    container_list = read_container_config_file()

    if not container_list:
        print("No containers defined.  Please create a new container before installing a package.")
        sys.exit(1)

    for container in container_list['containerList']:
        if container['id'] == container_id:
            package_obj = {'packageName': package_name, 'appStatus': 'new'}

            if not container['installedApps']:
                container['installedApps'] = [package_obj]
            else:
                container['installedApps'].append(package_obj)

            write_container_config_file(container_list)
            break


def delete_package(container_id, package_name):
    container_list = read_container_config_file()

    if not container_list:
        print("No containers defined.  Please create a new container before installing a package.")
        sys.exit(1)

    for container in container_list['containerList']:
        if container['id'] == container_id:
            for package in container['installedApps']:
                if package['packageName'] == package_name:
                    container['installedApps'].remove(package)
                    write_container_config_file(container_list)
                    return

    print("Package \'%s\' does not exist." % package_name)
    sys.exit(1)


def create(args):
    password = None

    if args.distro and not is_distro_valid(args.distro):
        print("Invalid distro %s" % args.distro, file=sys.stderr)
        sys.exit(1)

    if not args.distro:
        args.distro = get_host_distro_release()

    if not args.name:
        args.name = "Ubuntu \'" + get_distro_codename(args.distro) + "\'"

    if args.id and container_exists(args.id):
        print("Container id \'%s\' is already used." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_unique_container_id(distro)

    if args.type == "lxc":
        if sys.stdin.isatty():
            print("Your user password is required for creating a Libertine container.")
            password = getpass.getpass()
        else:
            password = sys.stdin.readline().rstrip()

    add_new_container(args.id, args.name, args.type, args.distro)

    container = LibertineContainer(args.id, args.type)
    update_container_install_status(args.id, "installing")
    container.create_libertine_container(password, args.verbosity)
    update_container_install_status(args.id, "ready")


def destroy(args):
    if args.id and not container_exists(args.id):
        print("Container id \'%s\' does not exist." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_default_container_id()

    container = LibertineContainer(args.id, libertine.utils.get_libertine_container_type(args.id))
    container.destroy_libertine_container()
    delete_container(args.id)


def install_package(args):
    if args.id and not container_exists(args.id):
        print("Container id \'%s\' does not exist." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_default_container_id()

    if package_exists(args.id, args.package):
        print("Package \'%s\' is already installed." % args.package)
        sys.exit(1)

    add_new_package(args.id, args.package)

    container = LibertineContainer(args.id, libertine.utils.get_libertine_container_type(args.id))

    update_package_install_status(args.id, args.package, "installing")
    if not container.install_package(args.package, args.verbosity):
        delete_package(args.id, args.package)
        sys.exit(1)

    update_package_install_status(args.id, args.package, "installed")


def remove_package(args):
    if args.id and not container_exists(args.id):
        print("Container id \'%s\' does not exist." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_default_container_id()

    if not package_exists(args.id, args.package):
        print("Package \'%s\' is not installed." % args.package)
        sys.exit(1)

    container = LibertineContainer(args.id, libertine.utils.get_libertine_container_type(args.id))
    container.remove_package(args.package, args.verbosity)

    delete_package(args.id, args.package)


def search_cache(args):
    if args.id and not container_exists(args.id):
        print("Container id \'%s\' does not exist." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_default_container_id()

    container = LibertineContainer(args.id, libertine.utils.get_libertine_container_type(args.id))
    container.search_package_cache(args.search_string)


def update(args):
    if args.id and not container_exists(args.id):
        print("Container id \'%s\' does not exist." % args.id, file=sys.stderr)
        sys.exit(1)
    elif not args.id:
        args.id = get_default_container_id()

    container = LibertineContainer(args.id, libertine.utils.get_libertine_container_type(args.id))
    container.update_libertine_container(args.verbosity)


def list(args):
    containers = libertine.utils.Libertine.list_containers()
    for container in containers:
        print("%s" % container)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Legacy X application support for Unity 8")
    parser.add_argument('-q', '--quiet',
                        action='store_const', dest='verbosity', const=0,
                        help=('do not print status updates on stdout'))
    parser.add_argument('-v', '--verbose',
                        action='store_const', dest='verbosity', const=2,
                        help=('extra verbose output'))
    subparsers = parser.add_subparsers(dest="subparser_name")

    # Handle the create command and its options
    parser_create = subparsers.add_parser(
        'create',
        help=("Create a new Libertine container."))
    parser_create.add_argument(
        '-i', '--id',
        required=True,
        help=("Container identifier."))
    parser_create.add_argument(
        '-t', '--type', default="lxc",
        help=("Type of Libertine container to create. Either 'lxc' or 'chroot'."))
    parser_create.add_argument(
        '-d', '--distro',
        help=("Ubuntu distro series to create."))
    parser_create.add_argument(
        '-n', '--name',
        help=("User friendly container name."))
    parser_create.set_defaults(func=create)

    # Handle the destroy command and its options
    parser_destroy = subparsers.add_parser(
        'destroy',
        help=("Destroy any existing environment entirely."))
    parser_destroy.add_argument(
        '-i', '--id',
        help=("Container identifier.  Default container is used if omitted."))
    parser_destroy.set_defaults(func=destroy)

    # Handle the install-package command and its options
    parser_install = subparsers.add_parser(
        'install-package',
        help=("Install a package in the specified Libertine container."))
    parser_install.add_argument(
        '-p', '--package',
        required=True,
        help=("Name of package to install."))
    parser_install.add_argument(
        '-i', '--id',
        help=("Container identifier.  Default container is used if omitted."))
    parser_install.set_defaults(func=install_package)

    # Handle the remove-package command and its options
    parser_install = subparsers.add_parser(
        'remove-package',
        help=("Remove a package in the specified Libertine container."))
    parser_install.add_argument(
        '-p', '--package',
        required=True,
        help=("Name of package to install."))
    parser_install.add_argument(
        '-i', '--id',
        help=("Container identifier.  Default container is used if omitted."))
    parser_install.set_defaults(func=remove_package)

    # Handle the search-cache command and its options
    parser_search = subparsers.add_parser(
        'search-cache',
        help=("Search for packages based on the search string in the specified Libertine container."))
    parser_search.add_argument(
        '-s', '--search-string',
        required=True,
        help=("String to search for in the package cache."))
    parser_search.add_argument(
        '-i', '--id',
        help=("Container identifier.  Default container is used if omitted."))
    parser_search.set_defaults(func=search_cache)

    # Handle the update command and its options
    parser_update = subparsers.add_parser(
        'update',
        help=("Update the packages in the Libertine container."))
    parser_update.add_argument(
        '-i', '--id',
        help=("Container identifier.  Default container is used if omitted."))
    parser_update.set_defaults(func=update)

    # Handle the list command
    parser_list = subparsers.add_parser(
        "list",
        help=("List all Libertine containers."))
    parser_list.set_defaults(func=list)

    args = parser.parse_args()
    if args.verbosity is None:
        args.verbosity = 1

    args.func(args)
